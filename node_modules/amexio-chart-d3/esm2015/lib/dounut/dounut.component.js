/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,uselessCode} checked by tsc
 */
import { Component, Input, ViewChild, ElementRef, ChangeDetectorRef } from '@angular/core';
import * as d3 from 'd3';
import { AmexioD3BaseChartComponent } from '../base/base.component';
import { CommanDataService } from '../services/comman.data.service';
export class AmexioD3DounutChartComponent extends AmexioD3BaseChartComponent {
    /**
     * @param {?} myservice
     * @param {?} cdf
     */
    constructor(myservice, cdf) {
        super('DONUTCHART');
        this.myservice = myservice;
        this.cdf = cdf;
        this.pie = false;
        this.svgwidth = 300;
        this.svgheight = 300;
        this.labelcolor = "black";
        this.labelflag = false;
        this.level = 0;
        this.drillableFlag = true;
        this.keyArray = [];
        this.transformeddata = [];
        this.legendArray = [];
    }
    /**
     * @return {?}
     */
    ngOnInit() {
        if (this.level <= 1) {
            /** @type {?} */
            let resp;
            if (this.httpmethod && this.httpurl) {
                this.myservice.fetchUrlData(this.httpurl, this.httpmethod).subscribe((response) => {
                    resp = response;
                }, (error) => {
                }, () => {
                    setTimeout(() => {
                        this.data = this.getResponseData(resp);
                        this.drawChart();
                        this.data = this.getResponseData(resp);
                        //this.transformData(this.data);
                        this.initializeData();
                        this.plotD3Chart();
                    }, 0);
                });
            }
            else if (this.data) {
                setTimeout(() => {
                    this.data = this.getResponseData(this.data);
                    this.transformData(this.data);
                    this.initializeData();
                    this.plotD3Chart();
                }, 0);
            }
        }
        else {
            this.fetchData(this.drillData);
        }
    }
    /**
     * @param {?} data
     * @return {?}
     */
    fetchData(data) {
        /** @type {?} */
        let requestJson;
        /** @type {?} */
        let key = this.drillabledatakey;
        /** @type {?} */
        let resp;
        if (this.drillabledatakey.length) {
            /** @type {?} */
            let drillabledata = this.getMultipleDrillbleKeyData(data, key);
            requestJson = drillabledata;
        }
        else {
            requestJson = data;
        }
        if (this.httpmethod && this.httpurl) {
            this.myservice.postfetchData(this.httpurl, this.httpmethod, requestJson).subscribe((response) => {
                resp = response;
                this.response = resp;
            }, (error) => {
            }, () => {
                setTimeout(() => {
                    this.data = this.getResponseData(resp);
                    this.drawChart();
                }, 0);
            });
        }
    }
    /**
     * @return {?}
     */
    drawChart() {
        setTimeout(() => {
            this.drillableFlag = true;
            this.initializeData();
            this.plotD3Chart();
        }, 0);
    }
    /**
     * @param {?} httpResponse
     * @return {?}
     */
    getResponseData(httpResponse) {
        /** @type {?} */
        let responsedata = httpResponse;
        if (this.datareader != null) {
            /** @type {?} */
            const dr = this.datareader.split('.');
            for (const ir of dr) {
                responsedata = responsedata[ir];
            }
        }
        else {
            responsedata = httpResponse;
        }
        return responsedata;
    }
    /**
     * @return {?}
     */
    plotD3Chart() {
        this.formLegendData();
        //this.transformData(this.data);
        //  this.data = this.transformeddata;
        /** @type {?} */
        let outerRadius = 0;
        /** @type {?} */
        let innerRadius = 0;
        outerRadius = this.svgwidth / 2;
        innerRadius = this.svgwidth / 4;
        if (this.pie) {
            innerRadius = 0;
        }
        /** @type {?} */
        const tooltip = this.toolTip(d3);
        /** @type {?} */
        const arc = d3.arc()
            .outerRadius(outerRadius)
            .innerRadius(innerRadius);
        /** @type {?} */
        const pie = d3.pie()
            .value((d) => {
            return d[Object.keys(d)[1]];
            //  return d.value
        });
        this.svg = d3.select("#" + this.componentId)
            .append('g')
            .attr('transform', 'translate(' + this.svgwidth / 2 + ',' + this.svgheight / 2 + ')')
            .selectAll('path')
            .data(pie(this.data))
            .enter();
        /** @type {?} */
        const path = this.svg.append('path')
            .attr('d', arc)
            .attr('fill', function (d, i) {
            if (d.data.color) {
                return d.data.color;
            }
            else {
                return "black";
            }
            //  return (d && d.data && d.data.color) ? d.data.color : "black"
        })
            .attr('cursor', 'pointer')
            .on("mouseover", (d) => {
            return tooltip.style("visibility", "visible");
        })
            .on("mousemove", (d) => {
            return tooltip.html(this.formTooltipData(d.data)
            //  this.formLegendData(d.data)
            // this.toolTipContent(d.data)
            )
                .style("top", (d3.event.pageY - 10) + "px")
                .style("left", (d3.event.pageX + 10) + "px");
        })
            .on("mouseout", (d) => {
            return tooltip.style("visibility", "hidden");
        })
            .on("click", (d) => {
            this.DonutChartClick(d.data);
            this.fordrillableClick(this, d.data, event);
            return tooltip.style("visibility", "hidden");
            //this.chartClick(d.data);
        });
        if (this.labelflag) {
            /** @type {?} */
            const text = this.svg.append("text")
                .transition()
                .duration(200)
                .attr("transform", function (d) {
                return "translate(" + arc.centroid(d) + ")";
            })
                .attr("text-anchor", "middle")
                .text(function (d) {
                return d.data[Object.keys(d.data)[1]];
                //return d.data.value;
            })
                .style('fill', function (d) {
                if (this.labelcolor.length > 0) {
                    return this.labelcolor;
                }
                else {
                    return "black";
                }
                // return (d && d.data && d.data.textcolor) ? d.data.textcolor : "black";
            })
                .style('font-size', '12px');
        }
    }
    /**
     * @return {?}
     */
    formLegendData() {
        this.legendArray = [];
        this.data.forEach(element => {
            /** @type {?} */
            let legendobject = {};
            legendobject['label'] = element[Object.keys(element)[0]];
            legendobject['value'] = element[Object.keys(element)[1]];
            legendobject['color'] = element.color;
            this.legendArray.push(legendobject);
        });
    }
    /**
     * @param {?} legendevent
     * @return {?}
     */
    onDonutLegendClick(legendevent) {
        /** @type {?} */
        let obj = {};
        //  obj['label'] = legendevent.label;
        //  obj['value'] = legendevent.value 
        obj[this.keyArray[0]] = legendevent.label;
        obj[this.keyArray[1]] = legendevent.value;
        //delete event.color;
        this.legendClick(obj);
    }
    /**
     * @param {?} data
     * @return {?}
     */
    transformData(data) {
        this.keyArray = data[0];
        data.forEach((element, index) => {
            if (index > 0) {
                /** @type {?} */
                let DummyObject = {};
                element.forEach((individualvalue, keyindex) => {
                    DummyObject[this.keyArray[keyindex]] = individualvalue;
                }); //inner for loop ends
                this.transformeddata.push(DummyObject);
            } //if ends
        }); //outer for loop ends
        this.data = this.transformeddata;
    }
    /**
     * @param {?} tooltipData
     * @return {?}
     */
    formTooltipData(tooltipData) {
        /** @type {?} */
        let object = {};
        for (let [key, value] of Object.entries(tooltipData)) {
            if (key != 'color' && key != 'textcolor') {
                object[key] = value;
            }
        }
        return this.toolTipForBar(object);
    }
    /**
     * @param {?} event
     * @return {?}
     */
    DonutChartClick(event) {
        /** @type {?} */
        let object = {};
        for (let [key, value] of Object.entries(event)) {
            if (key != 'color') {
                object[key] = value;
            }
        }
        this.chartClick(object);
    }
}
AmexioD3DounutChartComponent.decorators = [
    { type: Component, args: [{
                selector: 'amexio-d3-chart-donut',
                template: `<div *ngIf="drillableFlag" #chartId>


    <div colspan="2" style="font-size: 18px; font-weight: bold; ">
        {{title}}
    </div>
        <div style="display: flex;flex-direction: row">
            <svg preserveAspectRatio="xMinYMin meet" viewBox="0 0 300 300" [attr.height]="height" [attr.width]="width" [attr.id]="componentId">
            </svg>
            <div>

           <div style="display: block; padding: 1%;">
                    <amexio-d3-legend *ngIf="legend" (onClick)="onDonutLegendClick($event)" [data]="legendArray" style="height:100%;"></amexio-d3-legend>
          </div>
   </div>
    `
            },] },
];
AmexioD3DounutChartComponent.ctorParameters = () => [
    { type: CommanDataService },
    { type: ChangeDetectorRef }
];
AmexioD3DounutChartComponent.propDecorators = {
    pie: [{ type: Input, args: ['pie',] }],
    svgwidth: [{ type: Input, args: ['width',] }],
    svgheight: [{ type: Input, args: ['height',] }],
    chartId: [{ type: ViewChild, args: ['chartId',] }],
    labelcolor: [{ type: Input, args: ['label-color',] }],
    labelflag: [{ type: Input, args: ['label',] }],
    divid: [{ type: ViewChild, args: ['divid',] }],
    drillid: [{ type: ViewChild, args: ['drillid',] }],
    datareader: [{ type: Input, args: ['data-reader',] }],
    level: [{ type: Input, args: ['level',] }],
    target: [{ type: Input, args: ['target',] }],
    drillData: [{ type: Input }],
    drillabledatakey: [{ type: Input, args: ['drillable-data',] }]
};
if (false) {
    /** @type {?} */
    AmexioD3DounutChartComponent.prototype.pie;
    /** @type {?} */
    AmexioD3DounutChartComponent.prototype.svgwidth;
    /** @type {?} */
    AmexioD3DounutChartComponent.prototype.svgheight;
    /** @type {?} */
    AmexioD3DounutChartComponent.prototype.chartId;
    /** @type {?} */
    AmexioD3DounutChartComponent.prototype.labelcolor;
    /** @type {?} */
    AmexioD3DounutChartComponent.prototype.labelflag;
    /** @type {?} */
    AmexioD3DounutChartComponent.prototype.divid;
    /** @type {?} */
    AmexioD3DounutChartComponent.prototype.drillid;
    /** @type {?} */
    AmexioD3DounutChartComponent.prototype.datareader;
    /** @type {?} */
    AmexioD3DounutChartComponent.prototype.level;
    /** @type {?} */
    AmexioD3DounutChartComponent.prototype.target;
    /** @type {?} */
    AmexioD3DounutChartComponent.prototype.drillData;
    /** @type {?} */
    AmexioD3DounutChartComponent.prototype.drillabledatakey;
    /** @type {?} */
    AmexioD3DounutChartComponent.prototype.drillableFlag;
    /** @type {?} */
    AmexioD3DounutChartComponent.prototype.keyArray;
    /** @type {?} */
    AmexioD3DounutChartComponent.prototype.transformeddata;
    /** @type {?} */
    AmexioD3DounutChartComponent.prototype.legendArray;
    /** @type {?} */
    AmexioD3DounutChartComponent.prototype.response;
    /** @type {?} */
    AmexioD3DounutChartComponent.prototype.svg;
    /** @type {?} */
    AmexioD3DounutChartComponent.prototype.myservice;
    /** @type {?} */
    AmexioD3DounutChartComponent.prototype.cdf;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZG91bnV0LmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL2FtZXhpby1jaGFydC1kMy8iLCJzb3VyY2VzIjpbImxpYi9kb3VudXQvZG91bnV0LmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUFFLFNBQVMsRUFBZ0IsS0FBSyxFQUFrQixTQUFTLEVBQUUsVUFBVSxFQUFFLGlCQUFpQixFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ3pILE9BQU8sS0FBSyxFQUFFLE1BQU0sSUFBSSxDQUFDO0FBQ3pCLE9BQU8sRUFBRSwwQkFBMEIsRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBR3BFLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLGlDQUFpQyxDQUFDO0FBcUJwRSxNQUFNLG1DQUFvQyxTQUFRLDBCQUEwQjs7Ozs7SUFxQjFFLFlBQW9CLFNBQTRCLEVBQVUsR0FBc0I7UUFDOUUsS0FBSyxDQUFDLFlBQVksQ0FBQyxDQUFDO1FBREYsY0FBUyxHQUFULFNBQVMsQ0FBbUI7UUFBVSxRQUFHLEdBQUgsR0FBRyxDQUFtQjtRQW5CbEUsUUFBRyxHQUFZLEtBQUssQ0FBQztRQUNuQixhQUFRLEdBQVcsR0FBRyxDQUFDO1FBQ3RCLGNBQVMsR0FBVyxHQUFHLENBQUM7UUFFbkIsZUFBVSxHQUFXLE9BQU8sQ0FBQztRQUNuQyxjQUFTLEdBQVksS0FBSyxDQUFDO1FBSTNCLFVBQUssR0FBVyxDQUFDLENBQUM7UUFJbEMsa0JBQWEsR0FBWSxJQUFJLENBQUM7UUFDOUIsYUFBUSxHQUFVLEVBQUUsQ0FBQztRQUNyQixvQkFBZSxHQUFVLEVBQUUsQ0FBQztRQUM1QixnQkFBVyxHQUFVLEVBQUUsQ0FBQztJQUt4QixDQUFDOzs7O0lBRUQsUUFBUTtRQUVOLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxLQUFLLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQzs7Z0JBQ2hCLElBQVM7WUFDYixFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMs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QUFFOzs7Ozs7Ozs7Ozs7Ozs7S0FlUDthQUNKOzs7WUFwQlEsaUJBQWlCO1lBTHNELGlCQUFpQjs7O2tCQTRCOUYsS0FBSyxTQUFDLEtBQUs7dUJBQ1gsS0FBSyxTQUFDLE9BQU87d0JBQ2IsS0FBSyxTQUFDLFFBQVE7c0JBQ2QsU0FBUyxTQUFDLFNBQVM7eUJBQ25CLEtBQUssU0FBQyxhQUFhO3dCQUNuQixLQUFLLFNBQUMsT0FBTztvQkFDYixTQUFTLFNBQUMsT0FBTztzQkFDakIsU0FBUyxTQUFDLFNBQVM7eUJBQ25CLEtBQUssU0FBQyxhQUFhO29CQUNuQixLQUFLLFNBQUMsT0FBTztxQkFDYixLQUFLLFNBQUMsUUFBUTt3QkFDZCxLQUFLOytCQUNMLEtBQUssU0FBQyxnQkFBZ0I7Ozs7SUFadkIsMkNBQW1DOztJQUNuQyxnREFBdUM7O0lBQ3ZDLGlEQUF5Qzs7SUFDekMsK0NBQTBDOztJQUMxQyxrREFBbUQ7O0lBQ25ELGlEQUEyQzs7SUFDM0MsNkNBQXNDOztJQUN0QywrQ0FBbUM7O0lBQ25DLGtEQUF5Qzs7SUFDekMsNkNBQWtDOztJQUNsQyw4Q0FBZ0M7O0lBQ2hDLGlEQUF3Qjs7SUFDeEIsd0RBQThDOztJQUM5QyxxREFBOEI7O0lBQzlCLGdEQUFxQjs7SUFDckIsdURBQTRCOztJQUM1QixtREFBd0I7O0lBQ3hCLGdEQUFjOztJQUNkLDJDQUFTOztJQUNHLGlEQUFvQzs7SUFBRSwyQ0FBOEIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb21wb25lbnQsIEV2ZW50RW1pdHRlciwgSW5wdXQsIE9uSW5pdCwgT3V0cHV0LCBWaWV3Q2hpbGQsIEVsZW1lbnRSZWYsIENoYW5nZURldGVjdG9yUmVmIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgKiBhcyBkMyBmcm9tICdkMyc7XG5pbXBvcnQgeyBBbWV4aW9EM0Jhc2VDaGFydENvbXBvbmVudCB9IGZyb20gJy4uL2Jhc2UvYmFzZS5jb21wb25lbnQnO1xuaW1wb3J0IHsgUGxvdENhcnQgfSBmcm9tICcuLi9iYXNlL2NoYXJ0LmNvbXBvbmVudCc7XG5pbXBvcnQgeyBIdHRwQ2xpZW50LCBIdHRwQ2xpZW50TW9kdWxlIH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uL2h0dHAnO1xuaW1wb3J0IHsgQ29tbWFuRGF0YVNlcnZpY2UgfSBmcm9tICcuLi9zZXJ2aWNlcy9jb21tYW4uZGF0YS5zZXJ2aWNlJztcblxuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAnYW1leGlvLWQzLWNoYXJ0LWRvbnV0JyxcbiAgdGVtcGxhdGU6IGA8ZGl2ICpuZ0lmPVwiZHJpbGxhYmxlRmxhZ1wiICNjaGFydElkPlxuXG5cbiAgICA8ZGl2IGNvbHNwYW49XCIyXCIgc3R5bGU9XCJmb250LXNpemU6IDE4cHg7IGZvbnQtd2VpZ2h0OiBib2xkOyBcIj5cbiAgICAgICAge3t0aXRsZX19XG4gICAgPC9kaXY+XG4gICAgICAgIDxkaXYgc3R5bGU9XCJkaXNwbGF5OiBmbGV4O2ZsZXgtZGlyZWN0aW9uOiByb3dcIj5cbiAgICAgICAgICAgIDxzdmcgcHJlc2VydmVBc3BlY3RSYXRpbz1cInhNaW5ZTWluIG1lZXRcIiB2aWV3Qm94PVwiMCAwIDMwMCAzMDBcIiBbYXR0ci5oZWlnaHRdPVwiaGVpZ2h0XCIgW2F0dHIud2lkdGhdPVwid2lkdGhcIiBbYXR0ci5pZF09XCJjb21wb25lbnRJZFwiPlxuICAgICAgICAgICAgPC9zdmc+XG4gICAgICAgICAgICA8ZGl2PlxuXG4gICAgICAgICAgIDxkaXYgc3R5bGU9XCJkaXNwbGF5OiBibG9jazsgcGFkZGluZzogMSU7XCI+XG4gICAgICAgICAgICAgICAgICAgIDxhbWV4aW8tZDMtbGVnZW5kICpuZ0lmPVwibGVnZW5kXCIgKG9uQ2xpY2spPVwib25Eb251dExlZ2VuZENsaWNrKCRldmVudClcIiBbZGF0YV09XCJsZWdlbmRBcnJheVwiIHN0eWxlPVwiaGVpZ2h0OjEwMCU7XCI+PC9hbWV4aW8tZDMtbGVnZW5kPlxuICAgICAgICAgIDwvZGl2PlxuICAgPC9kaXY+XG4gICAgYFxufSlcbmV4cG9ydCBjbGFzcyBBbWV4aW9EM0RvdW51dENoYXJ0Q29tcG9uZW50IGV4dGVuZHMgQW1leGlvRDNCYXNlQ2hhcnRDb21wb25lbnQgaW1wbGVtZW50cyBQbG90Q2FydCB7XG5cbiAgQElucHV0KCdwaWUnKSBwaWU6IGJvb2xlYW4gPSBmYWxzZTtcbiAgQElucHV0KCd3aWR0aCcpIHN2Z3dpZHRoOiBudW1iZXIgPSAzMDA7XG4gIEBJbnB1dCgnaGVpZ2h0Jykgc3ZnaGVpZ2h0OiBudW1iZXIgPSAzMDA7XG4gIEBWaWV3Q2hpbGQoJ2NoYXJ0SWQnKSBjaGFydElkOiBFbGVtZW50UmVmO1xuICBASW5wdXQoJ2xhYmVsLWNvbG9yJykgbGFiZWxjb2xvcjogc3RyaW5nID0gXCJibGFja1wiO1xuICBASW5wdXQoJ2xhYmVsJykgbGFiZWxmbGFnOiBib29sZWFuID0gZmFsc2U7XG4gIEBWaWV3Q2hpbGQoJ2RpdmlkJykgZGl2aWQ6IEVsZW1lbnRSZWY7XG4gIEBWaWV3Q2hpbGQoJ2RyaWxsaWQnKSBkcmlsbGlkOiBhbnk7XG4gIEBJbnB1dCgnZGF0YS1yZWFkZXInKSBkYXRhcmVhZGVyOiBzdHJpbmc7XG4gIEBJbnB1dCgnbGV2ZWwnKSBsZXZlbDogbnVtYmVyID0gMDtcbiAgQElucHV0KCd0YXJnZXQnKSB0YXJnZXQ6IG51bWJlcjtcbiAgQElucHV0KCkgZHJpbGxEYXRhOiBhbnk7XG4gIEBJbnB1dCgnZHJpbGxhYmxlLWRhdGEnKSBkcmlsbGFibGVkYXRha2V5OiBhbnlcbiAgZHJpbGxhYmxlRmxhZzogYm9vbGVhbiA9IHRydWU7XG4gIGtleUFycmF5OiBhbnlbXSA9IFtdO1xuICB0cmFuc2Zvcm1lZGRhdGE6IGFueVtdID0gW107XG4gIGxlZ2VuZEFycmF5OiBhbnlbXSA9IFtdO1xuICByZXNwb25zZTogYW55O1xuICBzdmc6IGFueTtcbiAgY29uc3RydWN0b3IocHJpdmF0ZSBteXNlcnZpY2U6IENvbW1hbkRhdGFTZXJ2aWNlLCBwcml2YXRlIGNkZjogQ2hhbmdlRGV0ZWN0b3JSZWYpIHtcbiAgICBzdXBlcignRE9OVVRDSEFSVCcpO1xuICB9XG5cbiAgbmdPbkluaXQoKSB7XG5cbiAgICBpZiAodGhpcy5sZXZlbCA8PSAxKSB7XG4gICAgICBsZXQgcmVzcDogYW55O1xuICAgICAgaWYgKHRoaXMuaHR0cG1ldGhvZCAmJiB0aGlzLmh0dHB1cmwpIHtcbiAgICAgICAgdGhpcy5teXNlcnZpY2UuZmV0Y2hVcmxEYXRhKHRoaXMuaHR0cHVybCwgdGhpcy5odHRwbWV0aG9kKS5zdWJzY3JpYmUoKHJlc3BvbnNlKSA9PiB7XG4gICAgICAgICAgcmVzcCA9IHJlc3BvbnNlO1xuICAgICAgICB9LCAoZXJyb3IpID0+IHtcbiAgICAgICAgfSwgKCkgPT4ge1xuXG4gICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7XG5cbiAgICAgICAgICAgIHRoaXMuZGF0YSA9IHRoaXMuZ2V0UmVzcG9uc2VEYXRhKHJlc3ApO1xuICAgICAgICAgICAgdGhpcy5kcmF3Q2hhcnQoKTtcblxuICAgICAgICAgICAgdGhpcy5kYXRhID0gdGhpcy5nZXRSZXNwb25zZURhdGEocmVzcCk7XG4gICAgICAgICAgICAvL3RoaXMudHJhbnNmb3JtRGF0YSh0aGlzLmRhdGEpO1xuICAgICAgICAgICAgdGhpcy5pbml0aWFsaXplRGF0YSgpO1xuICAgICAgICAgICAgdGhpcy5wbG90RDNDaGFydCgpO1xuICAgICAgICAgIH0sIDApO1xuICAgICAgICB9KTtcblxuICAgICAgfSBlbHNlXG4gICAgICAgIGlmICh0aGlzLmRhdGEpIHtcblxuXG4gICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgICAgICB0aGlzLmRhdGEgPSB0aGlzLmdldFJlc3BvbnNlRGF0YSh0aGlzLmRhdGEpO1xuICAgICAgICAgICAgdGhpcy50cmFuc2Zvcm1EYXRhKHRoaXMuZGF0YSk7XG4gICAgICAgICAgICB0aGlzLmluaXRpYWxpemVEYXRhKCk7XG4gICAgICAgICAgICB0aGlzLnBsb3REM0NoYXJ0KCk7XG4gICAgICAgICAgfSwgMCk7XG4gICAgICAgIH1cbiAgICB9IGVsc2Uge1xuXG4gICAgICB0aGlzLmZldGNoRGF0YSh0aGlzLmRyaWxsRGF0YSk7XG4gICAgfVxuICB9XG5cblxuICBmZXRjaERhdGEoZGF0YTogYW55KSB7XG5cbiAgICBsZXQgcmVxdWVzdEpzb247XG4gICAgbGV0IGtleSA9IHRoaXMuZHJpbGxhYmxlZGF0YWtleTtcbiAgICBsZXQgcmVzcDogYW55O1xuXG4gICAgaWYgKHRoaXMuZHJpbGxhYmxlZGF0YWtleS5sZW5ndGgpIHtcbiAgICAgIGxldCBkcmlsbGFibGVkYXRhID0gdGhpcy5nZXRNdWx0aXBsZURyaWxsYmxlS2V5RGF0YShkYXRhLCBrZXkpO1xuICAgICAgcmVxdWVzdEpzb24gPSBkcmlsbGFibGVkYXRhO1xuICAgIH1cbiAgICBlbHNlIHtcbiAgICAgIHJlcXVlc3RKc29uID0gZGF0YTtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5odHRwbWV0aG9kICYmIHRoaXMuaHR0cHVybCkge1xuICAgICAgdGhpcy5teXNlcnZpY2UucG9zdGZldGNoRGF0YSh0aGlzLmh0dHB1cmwsIHRoaXMuaHR0cG1ldGhvZCwgcmVxdWVzdEpzb24pLnN1YnNjcmliZSgocmVzcG9uc2UpID0+IHtcbiAgICAgICAgcmVzcCA9IHJlc3BvbnNlO1xuICAgICAgICB0aGlzLnJlc3BvbnNlID0gcmVzcDtcbiAgICAgIH0sIChlcnJvcikgPT4ge1xuICAgICAgfSwgKCkgPT4ge1xuICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgICB0aGlzLmRhdGEgPSB0aGlzLmdldFJlc3BvbnNlRGF0YShyZXNwKTtcblxuICAgICAgICAgIHRoaXMuZHJhd0NoYXJ0KCk7XG5cbiAgICAgICAgfSwgMCk7XG4gICAgICB9KTtcbiAgICB9XG4gIH1cblxuICBkcmF3Q2hhcnQoKSB7XG4gICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICB0aGlzLmRyaWxsYWJsZUZsYWcgPSB0cnVlO1xuICAgICAgdGhpcy5pbml0aWFsaXplRGF0YSgpO1xuICAgICAgdGhpcy5wbG90RDNDaGFydCgpO1xuICAgIH0sIDApO1xuXG4gIH1cblxuICBnZXRSZXNwb25zZURhdGEoaHR0cFJlc3BvbnNlOiBhbnkpIHtcbiAgICBsZXQgcmVzcG9uc2VkYXRhID0gaHR0cFJlc3BvbnNlO1xuICAgIGlmICh0aGlzLmRhdGFyZWFkZXIgIT0gbnVsbCkge1xuICAgICAgY29uc3QgZHIgPSB0aGlzLmRhdGFyZWFkZXIuc3BsaXQoJy4nKTtcbiAgICAgIGZvciAoY29uc3QgaXIgb2YgZHIpIHtcbiAgICAgICAgcmVzcG9uc2VkYXRhID0gcmVzcG9uc2VkYXRhW2lyXTtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgcmVzcG9uc2VkYXRhID0gaHR0cFJlc3BvbnNlO1xuICAgIH1cbiAgICByZXR1cm4gcmVzcG9uc2VkYXRhO1xuICB9XG4gIHBsb3REM0NoYXJ0KCkge1xuICAgIHRoaXMuZm9ybUxlZ2VuZERhdGEoKTtcbiAgICAvL3RoaXMudHJhbnNmb3JtRGF0YSh0aGlzLmRhdGEpO1xuICAgIC8vICB0aGlzLmRhdGEgPSB0aGlzLnRyYW5zZm9ybWVkZGF0YTtcbiAgICBsZXQgb3V0ZXJSYWRpdXMgPSAwO1xuICAgIGxldCBpbm5lclJhZGl1cyA9IDA7XG5cbiAgICBvdXRlclJhZGl1cyA9IHRoaXMuc3Znd2lkdGggLyAyO1xuICAgIGlubmVyUmFkaXVzID0gdGhpcy5zdmd3aWR0aCAvIDQ7XG5cbiAgICBpZiAodGhpcy5waWUpIHtcbiAgICAgIGlubmVyUmFkaXVzID0gMDtcbiAgICB9XG5cbiAgICBjb25zdCB0b29sdGlwID0gdGhpcy50b29sVGlwKGQzKTtcblxuICAgIGNvbnN0IGFyYyA9IGQzLmFyYygpXG4gICAgICAub3V0ZXJSYWRpdXMob3V0ZXJSYWRpdXMpXG4gICAgICAuaW5uZXJSYWRpdXMoaW5uZXJSYWRpdXMpO1xuXG4gICAgY29uc3QgcGllID0gZDMucGllKClcbiAgICAgIC52YWx1ZSgoZCkgPT4ge1xuICAgICAgICByZXR1cm4gZFtPYmplY3Qua2V5cyhkKVsxXV07XG4gICAgICAgIC8vICByZXR1cm4gZC52YWx1ZVxuICAgICAgfSk7XG5cbiAgICB0aGlzLnN2ZyA9IGQzLnNlbGVjdChcIiNcIiArIHRoaXMuY29tcG9uZW50SWQpXG4gICAgICAuYXBwZW5kKCdnJylcbiAgICAgIC5hdHRyKCd0cmFuc2Zvcm0nLCAndHJhbnNsYXRlKCcgKyB0aGlzLnN2Z3dpZHRoIC8gMiArICcsJyArIHRoaXMuc3ZnaGVpZ2h0IC8gMiArICcpJylcbiAgICAgIC5zZWxlY3RBbGwoJ3BhdGgnKVxuICAgICAgLmRhdGEocGllKHRoaXMuZGF0YSkpXG4gICAgICAuZW50ZXIoKTtcblxuICAgIGNvbnN0IHBhdGggPSB0aGlzLnN2Zy5hcHBlbmQoJ3BhdGgnKVxuICAgICAgLmF0dHIoJ2QnLCBhcmMpXG4gICAgICAuYXR0cignZmlsbCcsIGZ1bmN0aW9uIChkLCBpKSB7XG4gICAgICAgIGlmIChkLmRhdGEuY29sb3IpIHtcbiAgICAgICAgICByZXR1cm4gZC5kYXRhLmNvbG9yO1xuICAgICAgICB9XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgIHJldHVybiBcImJsYWNrXCI7XG4gICAgICAgIH1cbiAgICAgICAgLy8gIHJldHVybiAoZCAmJiBkLmRhdGEgJiYgZC5kYXRhLmNvbG9yKSA/IGQuZGF0YS5jb2xvciA6IFwiYmxhY2tcIlxuICAgICAgfSlcbiAgICAgIC5hdHRyKCdjdXJzb3InLCAncG9pbnRlcicpXG4gICAgICAub24oXCJtb3VzZW92ZXJcIiwgKGQpID0+IHtcbiAgICAgICAgcmV0dXJuIHRvb2x0aXAuc3R5bGUoXCJ2aXNpYmlsaXR5XCIsIFwidmlzaWJsZVwiKTtcbiAgICAgIH0pXG4gICAgICAub24oXCJtb3VzZW1vdmVcIiwgKGQpID0+IHtcbiAgICAgICAgcmV0dXJuIHRvb2x0aXAuaHRtbChcbiAgICAgICAgICB0aGlzLmZvcm1Ub29sdGlwRGF0YShkLmRhdGEpXG5cbiAgICAgICAgICAvLyAgdGhpcy5mb3JtTGVnZW5kRGF0YShkLmRhdGEpXG4gICAgICAgICAgLy8gdGhpcy50b29sVGlwQ29udGVudChkLmRhdGEpXG4gICAgICAgIClcbiAgICAgICAgICAuc3R5bGUoXCJ0b3BcIiwgKGQzLmV2ZW50LnBhZ2VZIC0gMTApICsgXCJweFwiKVxuICAgICAgICAgIC5zdHlsZShcImxlZnRcIiwgKGQzLmV2ZW50LnBhZ2VYICsgMTApICsgXCJweFwiKTtcbiAgICAgIH0pXG4gICAgICAub24oXCJtb3VzZW91dFwiLCAoZCkgPT4ge1xuICAgICAgICByZXR1cm4gdG9vbHRpcC5zdHlsZShcInZpc2liaWxpdHlcIiwgXCJoaWRkZW5cIik7XG4gICAgICB9KVxuICAgICAgLm9uKFwiY2xpY2tcIiwgKGQpID0+IHtcbiAgICAgICAgdGhpcy5Eb251dENoYXJ0Q2xpY2soZC5kYXRhKTtcbiAgICAgICAgdGhpcy5mb3JkcmlsbGFibGVDbGljayh0aGlzLCBkLmRhdGEsIGV2ZW50KTtcbiAgICAgICAgcmV0dXJuIHRvb2x0aXAuc3R5bGUoXCJ2aXNpYmlsaXR5XCIsIFwiaGlkZGVuXCIpO1xuICAgICAgICAvL3RoaXMuY2hhcnRDbGljayhkLmRhdGEpO1xuICAgICAgfSk7XG4gICAgaWYgKHRoaXMubGFiZWxmbGFnKSB7XG4gICAgICBjb25zdCB0ZXh0ID0gdGhpcy5zdmcuYXBwZW5kKFwidGV4dFwiKVxuICAgICAgICAudHJhbnNpdGlvbigpXG4gICAgICAgIC5kdXJhdGlvbigyMDApXG4gICAgICAgIC5hdHRyKFwidHJhbnNmb3JtXCIsIGZ1bmN0aW9uIChkKSB7XG4gICAgICAgICAgcmV0dXJuIFwidHJhbnNsYXRlKFwiICsgYXJjLmNlbnRyb2lkKGQpICsgXCIpXCI7XG4gICAgICAgIH0pXG4gICAgICAgIC5hdHRyKFwidGV4dC1hbmNob3JcIiwgXCJtaWRkbGVcIilcbiAgICAgICAgLnRleHQoZnVuY3Rpb24gKGQpIHtcblxuICAgICAgICAgIHJldHVybiBkLmRhdGFbT2JqZWN0LmtleXMoZC5kYXRhKVsxXV1cblxuICAgICAgICAgIC8vcmV0dXJuIGQuZGF0YS52YWx1ZTtcbiAgICAgICAgfSlcbiAgICAgICAgLnN0eWxlKCdmaWxsJywgZnVuY3Rpb24gKGQpIHtcbiAgICAgICAgICBpZih0aGlzLmxhYmVsY29sb3IubGVuZ3RoPjApe1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMubGFiZWxjb2xvcjtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmV0dXJuIFwiYmxhY2tcIjtcbiAgICAgICAgICB9XG4gICAgICAgICAgLy8gcmV0dXJuIChkICYmIGQuZGF0YSAmJiBkLmRhdGEudGV4dGNvbG9yKSA/IGQuZGF0YS50ZXh0Y29sb3IgOiBcImJsYWNrXCI7XG4gICAgICAgIH0pXG4gICAgICAgIC5zdHlsZSgnZm9udC1zaXplJywgJzEycHgnKTtcbiAgICB9XG4gIH1cblxuICBmb3JtTGVnZW5kRGF0YSgpIHtcbiAgICB0aGlzLmxlZ2VuZEFycmF5ID0gW107XG4gICAgdGhpcy5kYXRhLmZvckVhY2goZWxlbWVudCA9PiB7XG4gICAgICBsZXQgbGVnZW5kb2JqZWN0ID0ge307XG4gICAgICBsZWdlbmRvYmplY3RbJ2xhYmVsJ10gPSBlbGVtZW50W09iamVjdC5rZXlzKGVsZW1lbnQpWzBdXTtcbiAgICAgIGxlZ2VuZG9iamVjdFsndmFsdWUnXSA9IGVsZW1lbnRbT2JqZWN0LmtleXMoZWxlbWVudClbMV1dO1xuICAgICAgbGVnZW5kb2JqZWN0Wydjb2xvciddID0gZWxlbWVudC5jb2xvcjtcbiAgICAgIHRoaXMubGVnZW5kQXJyYXkucHVzaChsZWdlbmRvYmplY3QpO1xuICAgIH0pO1xuICB9XG5cbiAgb25Eb251dExlZ2VuZENsaWNrKGxlZ2VuZGV2ZW50OiBhbnkpIHtcbiAgICBsZXQgb2JqID0ge307XG5cbiAgICAvLyAgb2JqWydsYWJlbCddID0gbGVnZW5kZXZlbnQubGFiZWw7XG4gICAgLy8gIG9ialsndmFsdWUnXSA9IGxlZ2VuZGV2ZW50LnZhbHVlIFxuICAgIG9ialt0aGlzLmtleUFycmF5WzBdXSA9IGxlZ2VuZGV2ZW50LmxhYmVsO1xuICAgIG9ialt0aGlzLmtleUFycmF5WzFdXSA9IGxlZ2VuZGV2ZW50LnZhbHVlO1xuICAgIC8vZGVsZXRlIGV2ZW50LmNvbG9yO1xuICAgIHRoaXMubGVnZW5kQ2xpY2sob2JqKTtcbiAgfVxuXG5cbiAgdHJhbnNmb3JtRGF0YShkYXRhOiBhbnkpIHtcbiAgICB0aGlzLmtleUFycmF5ID0gZGF0YVswXTtcbiAgICBkYXRhLmZvckVhY2goKGVsZW1lbnQsIGluZGV4KSA9PiB7XG4gICAgICBpZiAoaW5kZXggPiAwKSB7XG4gICAgICAgIGxldCBEdW1teU9iamVjdCA9IHt9O1xuICAgICAgICBlbGVtZW50LmZvckVhY2goKGluZGl2aWR1YWx2YWx1ZSwga2V5aW5kZXgpID0+IHtcbiAgICAgICAgICBEdW1teU9iamVjdFt0aGlzLmtleUFycmF5W2tleWluZGV4XV0gPSBpbmRpdmlkdWFsdmFsdWU7XG4gICAgICAgIH0pOy8vaW5uZXIgZm9yIGxvb3AgZW5kc1xuICAgICAgICB0aGlzLnRyYW5zZm9ybWVkZGF0YS5wdXNoKER1bW15T2JqZWN0KTtcbiAgICAgIH0vL2lmIGVuZHNcbiAgICB9KTsvL291dGVyIGZvciBsb29wIGVuZHNcbiAgICB0aGlzLmRhdGEgPSB0aGlzLnRyYW5zZm9ybWVkZGF0YTtcbiAgfVxuXG4gIGZvcm1Ub29sdGlwRGF0YSh0b29sdGlwRGF0YTogYW55KSB7XG4gICAgbGV0IG9iamVjdCA9IHt9O1xuICAgIGZvciAobGV0IFtrZXksIHZhbHVlXSBvZiBPYmplY3QuZW50cmllcyh0b29sdGlwRGF0YSkpIHtcbiAgICAgIGlmIChrZXkgIT0gJ2NvbG9yJyAmJiBrZXkgIT0gJ3RleHRjb2xvcicpIHtcbiAgICAgICAgb2JqZWN0W2tleV0gPSB2YWx1ZTtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHRoaXMudG9vbFRpcEZvckJhcihvYmplY3QpO1xuICB9XG5cbiAgRG9udXRDaGFydENsaWNrKGV2ZW50OiBhbnkpIHtcbiAgICBsZXQgb2JqZWN0ID0ge307XG4gICAgZm9yIChsZXQgW2tleSwgdmFsdWVdIG9mIE9iamVjdC5lbnRyaWVzKGV2ZW50KSkge1xuICAgICAgaWYgKGtleSAhPSAnY29sb3InKSB7XG4gICAgICAgIG9iamVjdFtrZXldID0gdmFsdWU7XG4gICAgICB9XG4gICAgfVxuICAgIHRoaXMuY2hhcnRDbGljayhvYmplY3QpO1xuICB9XG5cbn1cbiJdfQ==